# 用户验收测试 (UAT) 计划

## 1. 目标

本 UAT 计划旨在验证 API 网关的核心功能、稳定性、弹性和错误处理能力，确保其符合产品需求和质量标准，为正式发布做准备。

## 2. 测试范围

本次测试将覆盖以下所有核心功能模块：

- **核心代理功能**: 验证对 Google Generative Language API 的基本请求转发。
- **API 密钥管理**: 验证密钥池的轮换、状态标记（配额超限、服务错误）和恢复机制。
- **弹性重试机制**: 验证系统在面对不同类型错误（429, 5xx, 超时）时的重试逻辑。
- **OpenAI 路由代理**: 验证对 OpenAI API 的请求转发，包括普通模式和流式模式。
- **密钥验证端点**: 验证 `/verify` 端点的功能。
- **边界条件与错误处理**: 验证系统在极端或异常情况下的行为。

## 3. 测试环境

- **环境变量**: 必须设置 `GEMINI_API_KEYS`，包含一个或多个有效的 Google AI API 密钥。为完整测试，建议至少包含3个密钥，其中至少有一个是无效或额度耗尽的。

## 4. 测试用例

---

### **TC-CORE-01: 核心代理 - 成功请求**

- **目的**: 验证基本请求能成功代理到 Google API。
- **步骤**:
    1. 使用有效的 API 密钥配置环境变量。
    2. 向网关发送一个合法的 `generateContent` 请求。
- **预期结果**:
    - 返回 `200 OK` 状态码。
    - 响应内容与直接调用 Google API 的结果一致。

### **TC-KEY-01: 密钥管理 - 密钥轮换**

- **目的**: 验证每次请求是否使用不同的密钥。
- **步骤**:
    1. 使用至少3个有效的 API 密钥。
    2. 连续发送3次请求。
    3. (需要 `developer` 协助) 在 `handle_request.js` 中添加日志，打印出每次使用的 `apiKey`。
- **预期结果**:
    - 日志显示每次请求使用了不同的密钥，实现了轮换。

### **TC-KEY-02: 密钥管理 - 配额超限处理**

- **目的**: 验证当一个密钥返回429错误时，系统能自动切换到下一个可用密钥。
- **步骤**:
    1. 使用两个密钥，其中第一个是已知配额超限的。
    2. 发送一个请求。
    3. (需要 `developer` 协助) 观察内部日志。
- **预期结果**:
    - 第一次使用密钥1请求失败 (429)。
    - 系统自动重试，切换到密钥2并请求成功。
    - 最终请求成功，返回 `200 OK`。
    - `keyManager` 将密钥1标记为 `quotaExceeded: true`。

### **TC-KEY-03: 密钥管理 - 所有密钥均不可用**

- **目的**: 验证当所有密钥都配额超限时，系统能返回正确的错误。
- **步骤**:
    1. 使用的全部密钥都设置为已知配额超限的。
    2. 发送一个请求。
- **预期结果**:
    - 在所有重试次数用尽后，返回 `502 Bad Gateway` 或类似错误。
    - 响应体包含错误信息，如 "All API keys are currently unavailable."。

### **TC-RETRY-01: 弹性机制 - 5xx 服务错误重试**

- **目的**: 验证当上游服务返回 5xx 错误时，系统能按策略进行重试。
- **步骤**:
    1. (需要 `developer` 协助) 模拟 `fetch` 函数，使其在第一次调用时返回 `503 Service Unavailable`，在第二次调用时返回成功响应。
    2. 发送一个请求。
- **预期结果**:
    - 请求最终成功。
    - 内部日志显示至少进行了一次重试。

### **TC-RETRY-02: 弹性机制 - 请求超时重试**

- **目的**: 验证请求超时后，系统能增加超时时间并进行重试。
- **步骤**:
    1. (需要 `developer` 协助) 模拟 `fetch` 函数，使其第一次调用延迟时间超过初始超时时间，第二次调用正常响应。
    2. 发送请求。
- **预期结果**:
    - 请求最终成功。
    - 内部日志显示 `AdaptiveTimeout` 增加了超时设置。

### **TC-OPENAI-01: OpenAI 代理 - 非流式请求**

- **目的**: 验证对 `/v1/chat/completions` 的非流式请求能成功代理到 OpenAI。
- **步骤**:
    1. 向 `/v1/chat/completions` 发送一个合法的非流式请求。
- **预期结果**:
    - 返回 `200 OK`。
    - 响应体是标准的 OpenAI JSON 格式响应。

### **TC-OPENAI-02: OpenAI 代理 - 流式请求**

- **目的**: 验证对 `/v1/chat/completions` 的流式请求能成功代理。
- **步骤**:
    1. 向 `/v1/chat/completions` 发送一个 `stream: true` 的请求。
- **预期结果**:
    - 返回 `200 OK`。
    - 响应是 `text/event-stream` 类型。
    - 能持续接收到服务端发送的事件流数据块。

### **TC-VERIFY-01: 密钥验证 - 混合有效性**

- **目的**: 验证密钥验证端点能正确返回多个密钥的状态。
- **步骤**:
    1. 准备一个有效密钥和一个无效密钥。
    2. 将这两个密钥以逗号分隔，放入 `x-goog-api-key` 请求头中。
    3. 调用 `/verify` 端点 (或 `handleVerification` 函数)。
- **预期结果**:
    - 返回 `200 OK` 的流式响应。
    - 响应包含两条 `data:` 消息，分别指明第一个密钥状态为 'GOOD'，第二个为 'BAD' 或 'ERROR'。

---
## 5. 验收标准

- 所有测试用例必须 100% 通过。
- 在测试过程中，系统日志不能出现任何未被捕获的异常或严重错误。
- 性能：对于核心代理功能，额外的延迟开销应在可接受范围内（例如，< 100ms）。
