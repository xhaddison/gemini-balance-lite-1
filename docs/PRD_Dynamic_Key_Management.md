# **产品需求文档 (PRD): Web 界面动态密钥管理**

| **文档版本** | **状态** | **创建日期** | **作者** |
| :--- | :--- | :--- | :--- |
| v1.0 | 已定稿 | 2025-09-26 | Claude (AI产品经理) |

## 1. 背景与目标

### 1.1 背景
当前，系统的 API 密钥池依赖于部署时的环境变量配置。每当需要更新、添加或轮换密钥时，都必须手动修改服务器的环境变量并重新启动服务。这个过程不仅效率低下，容易出错，而且带来了不必要的服务中断风险。为了提升运维效率和系统的动态响应能力，我们需要一个更灵活、更安全的密钥管理方案。

### 1.2 目标
本功能旨在提供一个安全的、可视化的 Web 管理界面，允许授权的系统管理员能够动态、实时地更新 API 密钥池，而无需重启服务或直接操作服务器环境。

## 2. 用户故事

**角色:** 系统管理员

**故事:**
“作为一名系统管理员，我希望能通过一个安全的 Web 界面，上传一个包含最新 API 密钥列表的文件，并立即应用这些更新，这样我就不必再手动修改环境变量和重启服务，从而能够快速、安全地响应密钥轮换的需求。”

## 3. 功能需求

### 3.1 管理员认证
为了确保密钥更新操作的安全性，所有管理功能都必须受到严格的访问控制。

- **认证机制:** 系统需要一个简单的、基于密钥的登录机制。
- **管理员密钥:** 访问权限由一个硬编码的管理员密钥控制，该密钥通过服务器的环境变量 `ADMIN_LOGIN_KEY` 进行配置。只有持有此密钥的用户才能访问后续的管理功能。

### 3.2 前端界面

#### 3.2.1 登录页面
- **路径:** `/admin.html`
- **描述:** 一个简洁的登录表单页面。
- **组件:**
    - **密钥输入框:** 一个文本输入框，用于管理员输入 `ADMIN_LOGIN_KEY`。
    - **提交按钮:** 一个“登录”或“授权”按钮，用于提交密钥进行验证。

#### 3.2.2 密钥上传页面
- **路径:** `/admin/upload.html`
- **访问:** 此页面仅在管理员成功登录后才能访问。
- **描述:** 一个用于上传新密钥文件的界面。
- **组件:**
    - **文件选择框:** 一个标准的文件输入控件，允许管理员选择包含密钥列表的本地文件（例如 `.json` 或 `.txt` 格式）。
    - **密码输入框:** 在上传文件时，必须再次输入管理员密钥 (`ADMIN_LOGIN_KEY`) 作为二次验证，以防止跨站请求伪造 (CSRF) 等攻击。
    - **上传按钮:** 用于提交文件和密钥，触发后端的更新流程。

### 3.3 后端 API

#### 3.3.1 登录 API
- **路径:** `/api/login`
- **方法:** `POST`
- **请求体 (Content-Type: application/json):**
  ```json
  {
    "key": "管理员输入的密钥"
  }
  ```
- **核心逻辑:**
  1.  接收请求，获取 `key` 字段的值。
  2.  将接收到的 `key` 与环境变量 `ADMIN_LOGIN_KEY` 的值进行比较。
  3.  如果匹配，则返回成功响应，并设置一个有时效性的身份凭证（如 Cookie 或 Session），用于后续操作的授权。
  4.  如果- 不匹配，则返回认证失败的错误响应。

#### 3.3.2 密钥上传 API
- **路径:** `/api/upload-keys`
- **方法:** `POST`
- **请求体 (Content-Type: multipart/form-data):**
  - `keys_file`: 上传的密钥文件。
  - `admin_key`: 管理员在上传页面输入的密钥。
- **核心逻辑:**
  1.  **验证管理员密钥:** 必须首先验证请求中 `admin_key` 字段的有效性，将其与 `ADMIN_LOGIN_KEY` 环境变量进行比对。如果验证失败，立即拒绝请求。
  2.  **解析文件:** 在密钥验证通过后，解析上传的 `keys_file` 文件，提取出密钥列表。
  3.  **更新密钥池:** 调用 `IntelligentKeyScheduler` 实例的 `setKeys` 方法，将从文件中解析出的新密钥列表传入，以完成密钥池的动态更新。
  4.  **返回结果:** 根据更新结果，向前端返回成功或失败的响应。

## 4. 验收标准 (Acceptance Criteria)

- **AC-1 (登录失败):** 当在 `/admin.html` 页面输入错误的管理员密钥并提交时，登录请求应被拒绝，页面应提示错误信息，且用户无法跳转到上传页面。
- **AC-2 (登录成功):** 当在 `/admin.html` 页面输入正确的管理员密钥并提交时，用户应被成功重定向到 `/admin/upload.html` 页面。
- **AC-3 (上传认证失败):** 在上传页面，如果未提供或提供了错误的管理员密钥，上传请求应被 API 拒绝。
- **AC-4 (上传成功且密钥更新):** 在上传页面，当提供了正确的管理员密钥并成功上传了一个有效的密钥文件后，系统的密钥池应被立即更新为文件中的内容。可以通过相应的系统状态接口或日志来验证。
- **AC-5 (直接访问限制):** 未经登录的用户直接访问 `/admin/upload.html` 路径时，应被重定向回登录页面 `/admin.html`。