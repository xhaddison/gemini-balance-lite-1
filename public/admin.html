<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Key Management</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background-color: #f8f9fa; color: #333; }
        .container { max-width: 800px; margin: 2rem auto; padding: 2rem; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { color: #007bff; }
        h1 { text-align: center; margin-bottom: 2rem; }
        .key-list { list-style-type: none; padding: 0; margin-top: 1rem; }
        .key-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background-color: #f1f3f5; border-radius: 4px; margin-bottom: 0.5rem; word-break: break-all; }
        .key-item:nth-child(odd) { background-color: #e9ecef; }
        .delete-btn { background-color: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        .delete-btn:hover { background-color: #c82333; }
        .add-key-form { display: flex; gap: 1rem; margin-top: 2rem; }
        .add-key-form input { flex-grow: 1; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 4px; }
        .add-key-form button { background-color: #28a745; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; }
        .add-key-form button:hover { background-color: #218838; }
        .auth-container { text-align: center; }
        .auth-container input { padding: 0.5rem; min-width: 300px; margin-right: 1rem; }
        .message { padding: 1rem; margin: 1rem 0; border-radius: 4px; text-align: center; }
        .message.success { background-color: #d4edda; color: #155724; }
        .message.error { background-color: #f8d7da; color: #721c24; }
        .message.info { background-color: #e2e3e5; color: #383d41; }
        .message.warning { background-color: #fff3cd; color: #856404; }

        .secondary-btn {
            background-color: #6c757d;
            color: white;
        }
        .secondary-btn:hover {
            background-color: #5a6268;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #007bff;
            animation: spin 1s ease infinite;
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gemini API Key Management</h1>
        <div id="auth-section">
            <h2>Admin Login</h2>
            <div class="auth-container">
                <input type="password" id="admin-key" placeholder="Enter Admin Key" data-testid="admin-key-input">
                <button onclick="login()" data-testid="login-button">Login</button>
            </div>
        </div>

        <div id="management-section" style="display: none;" data-testid="key-management-section">
            <h2>Current Keys</h2>
            <ul id="key-list" class="key-list"></ul>
            <div id="message-container"></div>

            <h2>Add New Key</h2>
            <form id="add-key-form" class="add-key-form">
                <input type="text" id="new-key-input" placeholder="Enter new Gemini API Key" data-testid="new-key-input" required>
                <button type="submit" id="add-key-btn" data-testid="add-key-button">Add Key</button>
                <button type="button" id="bulk-upload-btn" class="secondary-btn">Bulk Upload</button>
            </form>
        </div>
    </div>

    <input type="file" id="key-file-input" accept=".txt" style="display: none;">

    <script>
        const authSection = document.getElementById('auth-section');
        const managementSection = document.getElementById('management-section');
        const adminKeyInput = document.getElementById('admin-key');
        const keyList = document.getElementById('key-list');
        const addKeyForm = document.getElementById('add-key-form');
        const newKeyInput = document.getElementById('new-key-input');
        const messageContainer = document.getElementById('message-container');
        const bulkUploadBtn = document.getElementById('bulk-upload-btn');
        const keyFileInput = document.getElementById('key-file-input');
        const addKeyBtn = document.getElementById('add-key-btn');

        let ADMIN_KEY = '';

        // --- Bulk Upload Logic ---
        bulkUploadBtn.addEventListener('click', () => {
            keyFileInput.click();
        });

        keyFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                uploadKeyFile(file);
            }
            // Reset file input to allow re-uploading the same file
            event.target.value = null;
        });

        async function uploadKeyFile(file) {
            setButtonsDisabled(true);
            showUploadSpinner();

            const formData = new FormData();
            formData.append('keyFile', file);

            try {
                const response = await fetch('/api/keys/bulk-upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + ADMIN_KEY
                    },
                    body: formData
                });
                const result = await response.json();
                handleUploadResponse(result);
            } catch (error) {
                showMessage('error', `An unexpected error occurred: ${error.message}`);
            } finally {
                setButtonsDisabled(false);
                fetchKeys(); // Always refresh the key list
            }
        }

        function handleUploadResponse(result) {
            const { success, total_keys_in_file, successfully_added, failed_entries, message } = result;

            if (!success) {
                showMessage('error', `Upload failed: ${message}`);
                return;
            }

            const failed_count = failed_entries ? failed_entries.length : 0;

            if (failed_count === 0 && successfully_added > 0) {
                showMessage('success', `Success! ${successfully_added} new API keys have been added.`);
            } else if (successfully_added > 0 && failed_count > 0) {
                const logUrl = generateFailureLog(failed_entries);
                messageContainer.innerHTML = `
                    <div class="message warning">
                        Operation complete. Successfully added: ${successfully_added}, Failed: ${failed_count}.
                        <a href="${logUrl}" download="failed_keys_log.txt">Download Failure Log</a>
                    </div>
                `;
            } else if (successfully_added === 0 && failed_count > 0) {
                 showMessage('error', `Upload failed. All ${failed_count} keys in the file were invalid or already exist.`);
            } else {
                 showMessage('error', 'Upload failed. The file may be empty or contain no valid keys.');
            }
        }

        function generateFailureLog(failedEntries) {
            let logContent = 'Failed to add the following keys:\n\n';
            failedEntries.forEach(entry => {
                const lineInfo = entry.line ? `(Line: ${entry.line}) ` : '';
                const keyInfo = entry.key ? `Key: ${entry.key}` : 'Entry';
                logContent += `${lineInfo}${keyInfo} - Reason: ${entry.reason}\n`;
            });
            const blob = new Blob([logContent], { type: 'text/plain' });
            return URL.createObjectURL(blob);
        }

        function showUploadSpinner() {
            messageContainer.innerHTML = `
                <div class="message info">
                    <div class="spinner"></div>
                    <span>Uploading and processing... Please wait.</span>
                </div>
            `;
        }

        function setButtonsDisabled(disabled) {
            addKeyBtn.disabled = disabled;
            bulkUploadBtn.disabled = disabled;
        }

        // --- Original Logic ---

        function login() {
            const key = adminKeyInput.value.trim();
            if (key) {
                ADMIN_KEY = key;
                // The UI state change should be driven by the result of fetchKeys, not optimistically here.
                fetchKeys();
            } else {
                alert('Admin key cannot be empty.');
            }
        }

        function showMessage(type, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            messageContainer.innerHTML = ''; // Clear previous messages
            messageContainer.appendChild(messageDiv);
            setTimeout(() => messageContainer.innerHTML = '', 5000);
        }

        async function fetchKeys() {
            try {
                const response = await fetch('/api/keys', {
                    headers: { 'Authorization': 'Bearer ' + ADMIN_KEY }
                });
                if (response.status === 401) {
                    logout();
                    return;
                }
                const data = await response.json();
                if (data.success) {
                    localStorage.setItem('admin_key', ADMIN_KEY); // Save key on successful login
                    authSection.style.display = 'none';
                    managementSection.style.display = 'block';
                    renderKeys(data.keys);
                } else {
                    showMessage('error', `Failed to fetch keys: ${data.message}`);
                }
            } catch (error) {
                showMessage('error', `An error occurred: ${error.message}`);
            }
        }

        function renderKeys(keys) {
            keyList.innerHTML = '';
            if (keys.length === 0) {
                keyList.innerHTML = '<li>No keys found.</li>';
                return;
            }
            keys.forEach(key => {
                const keyItem = createKeyItemElement(key);
                keyList.appendChild(keyItem);
            });
        }

        function createKeyItemElement(key) {
            const li = document.createElement('li');
            li.className = 'key-item';
            li.setAttribute('data-testid', `key-row-${key}`);
            li.innerHTML = `
                <span>${key}</span>
                <button class="delete-btn" data-key="${key}" data-testid="delete-btn-${key}">Delete</button>
            `;
            return li;
        }

        keyList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const key = e.target.dataset.key;
                deleteKey(key);
            }
        });

        addKeyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const keyToAdd = newKeyInput.value.trim();
            if (!keyToAdd) return;

            try {
                const response = await fetch('/api/keys', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + ADMIN_KEY
                    },
                    body: JSON.stringify({ key: keyToAdd })
                });
                const result = await response.json();
                 if (response.ok && result.success) {
                    showMessage('success', result.message || 'Key added successfully');
                    newKeyInput.value = '';
                    fetchKeys();
                } else {
                    showMessage('error', `Error: ${result.message || 'An unknown error occurred'}`);
                }
            } catch (error) {
                showMessage('error', `An error occurred: ${error.message}`);
            }
        });

        async function deleteKey(key) {
            // if (!confirm(`Are you sure you want to delete the key ending in ...${key.slice(-4)}?`)) {
            //     return;
            // }
            try {
                const response = await fetch('/api/keys', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + ADMIN_KEY
                    },
                    body: JSON.stringify({ key: key })
                });
                const result = await response.json();
                if (response.ok) {
                    showMessage('success', result.message);
                    const itemToRemove = keyList.querySelector(`[data-testid="key-row-${key}"]`);
                    if (itemToRemove) itemToRemove.remove();
                } else {
                    showMessage('error', `Error: ${result.message}`);
                }
            } catch (error) {
                showMessage('error', `An error occurred: ${error.message}`);
            }
        }

        function logout() {
            ADMIN_KEY = '';
            localStorage.removeItem('admin_key'); // Clear key from storage
            authSection.style.display = 'block';
            managementSection.style.display = 'none';
        }

        // Check login status on page load
        function checkLoginStatus() {
            const storedKey = localStorage.getItem('admin_key');
            if (storedKey) {
                ADMIN_KEY = storedKey;
                fetchKeys();
            }
        }

        // Initialize
        checkLoginStatus();

    </script>
</body>
</html>
