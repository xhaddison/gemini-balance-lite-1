### **智能调度系统 - 用户验收测试 (UAT) 报告**

**报告日期:** 2025年09月26日
**测试负责人:** Claude (AI Product Manager)
**测试对象:** `IntelligentKeyScheduler` in `src/key_manager.js`

**测试结论:** **UAT 通过**

**总体评估:**
`IntelligentKeyScheduler` 模块成功地实现了其核心设计目标。系统不仅能够正确处理API错误，更重要的是，它展现了高级的主动规避能力，能在达到速率限制前智能地进行负载均衡。状态持久化、计数器重置和日志记录等关键功能均符合预期。该系统已准备好投入生产环境。

---

### **详细测试发现**

#### **1. 主动规避 RPM 限制 (最高优先级): 测试通过**

*   **测试场景:** 模拟在单一Key的分钟请求数（`requests_this_minute`）接近 `RPM_LIMIT` (59) 的情况。
    *   **测试用例 1.1:** 当 `keyA` 的请求数为58，`keyB` 的请求数为10时，调用 `getKey()`。
        *   **测试结果:** **符合预期。** 系统返回了负载较低的 `keyB`。
    *   **测试用例 1.2:** 当所有可用Key的请求数都达到59时，调用 `getKey()`。
        *   **测试结果:** **符合预期。** 系统抛出了明确的错误 `Error: No available API key is under the rate limits. Please wait.`。

#### **2. 状态持久化正确性: 测试通过**

*   **测试场景:** 验证一个因达到每日配额（QPD）而被标记为 `expired` 的Key，在服务重启后能否保持其状态。
    *   **测试结果:** **符合预期。** Key的状态被正确设置为 `expired` 并被持久化。重启后，状态得以保留。

#### **3. 每日计数器重置: 测试通过**

*   **测试场景:** 模拟由Cron Job触发的 `resetDailyCounters` 方法调用。
    *   **测试结果:** **符合预期。** 所有Key的 `requests_today` 计数都被成功清零，`expired` 状态的Key被恢复为 `active`。

#### **4. 日志/告警的准确性: 测试通过**

*   **测试场景:** 触发关键的状态变更，验证控制台日志输出。
    *   **测试结果:** **符合预期。** 系统针对 `403 Forbidden` 和 `429 Too Many Requests` 等错误，输出了准确的日志信息。