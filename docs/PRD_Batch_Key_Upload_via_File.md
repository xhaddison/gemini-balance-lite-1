# PRD: 文件上传批量添加密钥

**版本:** 1.0
**日期:** 2025-10-03
**负责人:** Claude (Product Manager)

---

## 1. 功能概述

### 1.1 背景

当前管理员面板仅支持手动、逐一输入的方式添加API密钥。当需要添加大量密钥时，此操作流程效率低下、耗时，且极易因手动输入而出错。为了提升管理员的工作效率和操作准确性，我们计划引入一个通过文件上传来批量添加密钥的新功能。

### 1.2 业务目标

-   **提升效率:** 将添加100个密钥的时间从数十分钟缩短到1分钟以内。
-   **降低错误率:** 消除手动输入可能导致的拼写错误或格式错误。
-   **优化体验:** 改善管理员在密钥管理模块的操作体验。

---

## 2. 用户故事

**As an** (作为一名) `系统管理员`,
**I want** (我希望) `能够上传一个包含多个API密钥的文本文件来一次性将它们全部添加到系统中`,
**so that** (以便于) `我能快速、准确地完成大批量的密钥部署工作，而无需手动逐一添加`。

---

## 3. 功能详述

### 3.1 UI/UX 描述

1.  在现有的“添加密钥”按钮旁边，新增一个“**批量上传**”按钮。
2.  点击“批量上传”按钮，弹出一个文件选择对话框。
3.  用户选择文件并确认后，界面显示上传和处理中的状态提示（例如，一个loading spinner或进度条）。
4.  处理完成后，弹出一个结果摘要通知，告知用户成功、失败或部分成功的状态。

### 3.2 交互流程

1.  **触发**: 管理员点击“批量上传”按钮。
2.  **文件选择**:
    *   系统应限制可选择的文件类型为 `.txt`。
    *   用户选择一个 `.txt` 文件并点击“打开”。
3.  **上传与处理**:
    *   前端将文件上传至后端服务。
    *   后端逐行读取文件内容：
        *   忽略所有空行。
        *   对每一行的密钥进行格式校验和重复性检查（与数据库中现有密钥对比）。
    *   将所有验证通过的、不重复的密钥批量存入数据库。
4.  **结果反馈**:
    *   系统处理完成后，向前端返回一个包含处理结果的JSON对象，例如：
        ```json
        {
          "total_keys_in_file": 105,
          "successfully_added": 98,
          "failed_entries": [
            { "key": "key_format_invalid", "reason": "格式无效" },
            { "key": "key_already_exists", "reason": "密钥已存在" },
            { "line": 55, "reason": "格式无效" }
          ]
        }
        ```
    *   前端根据返回结果，向用户展示清晰的反馈信息：
        *   **全部成功**: “成功！已新增 98 个API密钥。”
        *   **部分成功**: “操作完成。成功新增 98 个密钥，3 个密钥添加失败。详情请查看下载日志。” 同时提供一个“下载失败日志”的链接。
        *   **全部失败**: “上传失败。文件内容为空或所有密钥均无效。请检查文件后重试。”

### 3.3 文件格式要求

-   **文件类型**: 纯文本文件 (`.txt`)。
-   **内容格式**: 每行包含一个API密钥。密钥前后不应有多余的空格（系统在处理时应自动trim）。

```
key_one_abcdefg
key_two_hijklmn
key_three_opqrstu
```

### 3.4 错误处理机制

-   **文件类型错误**: 如果用户选择了非 `.txt` 文件，文件选择框应直接拒绝。
-   **文件内容为空**: 上传后系统检测到文件为空，提示“上传失败。文件内容为空。”
-   **密钥格式无效**: 后端校验发现某行文本不符合API密钥的格式规范，将其计入失败列表。
-   **密钥已存在**: 后端校验发现某密钥已存在于数据库中，将其计入失败列表。

---

## 4. 验收标准 (Acceptance Criteria)

-   [ ] 管理员界面上必须有一个清晰可见的“批量上传”按钮。
-   [ ] 点击按钮后，可以成功打开操作系统的文件选择器，且文件类型被限定为 `.txt`。
-   [ ] 选择一个符合格式要求的 `.txt` 文件后，所有有效的、不重复的密钥都被成功添加到系统中。
-   [ ] 上传并处理过程中，界面必须有明确的加载状态提示。
-   [ ] 任务完成后，界面必须显示一个明确的结果摘要（成功、失败、部分成功）。
-   [ ] 如果存在添加失败的密钥，用户必须能够通过某种方式（如日志下载）获取到失败的密钥列表和失败原因。
-   [ ] 上传一个包含空行、重复密钥和无效密钥的混合文件，系统应能正确处理，只添加有效的密钥，并报告失败详情。
-   [ ] 上传一个空文件时，系统应提示错误，且数据库中不应有任何变更。
-   [ ] 整个操作流程必须顺畅，UI反馈及时且清晰。
