# UAT 计划：系统崩溃后紧急验证
## 版本: 4.0
## 状态: 待执行
## 日期: 2025-10-09

---

## 1. 核心目标

本次UAT的目标是**恢复对系统稳定性的绝对信心**。鉴于近期发生的系统崩溃，本计划将取代所有先前的测试报告，并作为验证系统是否符合核心需求的**唯一标准**。所有测试用例将严格依据 `docs/Final_Core_Requirements_v2.md` 进行。

---

## 2. 测试套件

### 套件 1: 运行时 - 核心熔断与重试逻辑

**目标:** 验证系统在面对不同类型的失败时，是否能精确执行需求文档中定义的四级熔断与重试策略。

| 测试用例 ID | 场景描述 | 触发条件 (模拟) | 预期密钥状态变更 | 预期行为 |
| :--- | :--- | :--- | :--- | :--- |
| **TC-RT-001** | **请求级永久失败** | API返回 `404 Not Found` | **无变更** | 立即终止，不重试，向客户端返回 `404` 错误。 |
| **TC-RT-002** | **密钥级永久失败** | API返回 `401 Unauthorized` | `status` -> `disabled`, `reason` -> `invalid_auth` | **自动重试**: 立即使用下一个可用密钥重试请求。 |
| **TC-RT-003** | **密钥级临时失败** | API返回 `429 Quota Exceeded` | `status` -> `disabled`, `reason` -> `quota_exceeded` | **自动重试**: 立即使用下一个可用密钥重试请求。 |
| **TC-RT-004** | **服务器级临时失败** | API返回 `502 Bad Gateway` | `status` -> `disabled`, `reason` -> `server_error` | **自动重试**: 立即使用下一个可用密钥重试请求。 |

### 套件 2: 运行时 - 边界条件与压力测试

**目标:** 验证系统在资源枯竭或极端失败条件下的行为是否健壮。

| 测试用例 ID | 场景描述 | 预置条件 | 预期行为 |
| :--- | :--- | :--- | :--- |
| **TC-BC-001** | **无可用密钥** | Redis中所有密钥的 `status` 均为 `in_use` 或 `disabled`。 | 系统应立即向上游返回明确的 "无可用资源" 错误 (例如 `503 Service Unavailable`)，而不是陷入无限循环或超时。 |
| **TC-BC-002** | **级联失败** | Redis中有3个 `available` 密钥，但API对这3个密钥的调用均依次返回 `401`、`429`、`502`。 | 系统应能平滑地、连续地重试3次，正确更新每个密钥的状态，最终在第3次失败后向上游返回相应的错误。 |

### 套件 3: 自愈平面 - 健康检查

**目标:** 验证健康检查Cron Job是否严格按照需求文档进行恢复操作。

| 测试用例 ID | 场景描述 | 预置密钥状态 | 预期恢复结果 |
| :--- | :--- | :--- | :--- |
| **TC-SH-001** | **正确恢复** | `status: disabled`, `reason: server_error`, `lastFailure` > 1小时前 | `status` 成功重置为 `available`。 |
| **TC-SH-002** | **禁止恢复 (配额)** | `status: disabled`, `reason: quota_exceeded` | 密钥状态**保持不变**。 |
| **TC-SH-003** | **禁止恢复 (无效)** | `status: disabled`, `reason: invalid_auth` | 密钥状态**保持不变**。 |

### 套件 4: 管理平面 - 手动控制

**目标:** 验证后台管理脚本是否能正确执行其核心功能。

| 测试用例 ID | 场景描述 | 执行脚本 | 预期结果 |
| :--- | :--- | :--- | :--- |
| **TC-MP-001** | **一键重置配额** | `scripts/manage-keys.js` | 所有 `reason` 为 `quota_exceeded` 的密钥，其 `status` 被成功更新回 `available`。 |

---

## 3. 验收标准

- **100% 通过率:** 所有测试用例必须**全部通过**，不存在任何“部分通过”或“可接受的失败”。
- **状态可验证:** 每一个测试步骤之后，都必须通过查询Redis来验证密钥的状态是否与预期完全一致。
- **日志清晰:** 整个测试过程的日志必须清晰、可追溯，能够明确展示系统的决策路径。
